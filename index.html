<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JTG FX JOURNAL</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0e29">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JTG Journal">
    <link rel="apple-touch-icon" href="IMG_20250624_114347.png">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"News Cycle"', 'sans-serif'] },
                    colors: {
                        jtg: {
                            green: '#1BA657',    
                            blue: '#162C99',     
                            dark: '#0a0e29',     
                            card: '#111633',     
                            input: '#1a214d',    
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- HTML2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=News+Cycle:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        html, body, #root { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #0a0e29; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        body { font-family: 'News Cycle', sans-serif; }
        .custom-scroll { overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0a0e29; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #162C99; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #1BA657; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.99); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 14, 41, 0.9); z-index: 50; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #111633; border: 1px solid #162C99; border-radius: 16px; width: 90%; max-width: 500px; padding: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); animation: popIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-jtg-dark text-slate-100 selection:bg-jtg-green selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const LOGO_URL = "IMG_20250624_114347.png";

        // --- FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDDNYlSKPd1Eef8FWCgphONTgWnw9-csrI",
            authDomain: "jtg-journal.firebaseapp.com",
            projectId: "jtg-journal",
            storageBucket: "jtg-journal.firebasestorage.app",
            messagingSenderId: "1051515355764",
            appId: "1:1051515355764:web:0c6c6f7417cb22b44e4721"
        };
        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e) {}
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- ICONS ---
        const Icons = {
            LogoFallback: () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="url(#brandGrad)" className="w-full h-full"><defs><linearGradient id="brandGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#1BA657" /><stop offset="100%" stopColor="#162C99" /></linearGradient></defs><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2-1-2-1-2 1 2 1zm0-3.5L6 7l6 2.5L18 7l-6-2.5zM2 17l10 5 10-5M2 12l10 5 10-5" /></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="14"></line><line x1="8" y1="14" x2="8" y2="14"></line><line x1="12" y1="14" x2="12" y2="14"></line><line x1="16" y1="18" x2="16" y2="18"></line><line x1="8" y1="18" x2="8" y2="18"></line><line x1="12" y1="18" x2="12" y2="18"></line></svg>,
            Journal: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>,
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>,
            Google: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>,
            Trophy2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 21h8m-4-9v9m-4.8-9a3 3 0 1 0 9.6 0M6 9H4a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h2m12-5h2a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-2"></path></svg>
        };

        const ASSETS = {
            indices: { label: 'Indices', pairs: ['GER40', 'JPN225', 'NAS100', 'SPX500', 'UK100', 'US30'], contract: 1 },
            metals: { label: 'Metals', pairs: ['XAGUSD', 'XAUUSD'], contract: 100 },
            crypto: { label: 'Crypto', pairs: ['BTCUSD', 'DOGEUSD', 'ETHUSD', 'LTCUSD', 'SOLUSD', 'XRPUSD'], contract: 1 },
            forex: { label: 'Forex', pairs: ['AUDCAD', 'AUDCHF', 'AUDJPY', 'AUDNZD', 'AUDUSD', 'CADCHF', 'CADJPY', 'CHFJPY', 'EURAUD', 'EURCAD', 'EURCHF', 'EURGBP', 'EURJPY', 'EURNZD', 'EURUSD', 'GBPAUD', 'GBPCAD', 'GBPCHF', 'GBPJPY', 'GBPNZD', 'GBPUSD', 'NZDCAD', 'NZDCHF', 'NZDJPY', 'NZDUSD', 'USDCAD', 'USDCHF', 'USDJPY', 'USDMXN', 'USDZAR'], contract: 100000 }
        };

        // --- PROFILE MANAGER ---
        const ProfileManager = ({ profiles, activeProfileId, onSwitch, onAdd, mobile }) => {
            const [showModal, setShowModal] = useState(false);
            const [newProfile, setNewProfile] = useState({ name: '', type: 'PERSONAL', balance: 1000, dailyLoss: 5, maxLoss: 10, profitTarget: 8 });
            const activeProfile = profiles.find(p => p.id === activeProfileId) || profiles[0];

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({ ...newProfile, id: Date.now().toString() });
                setShowModal(false);
                setNewProfile({ name: '', type: 'PERSONAL', balance: 1000, dailyLoss: 5, maxLoss: 10, profitTarget: 8 });
            };

            return (
                <div className={`px-4 mb-6 ${mobile ? 'w-auto p-0 mb-0' : 'w-full'}`}>
                    <div className="relative">
                        <button onClick={() => setShowModal(true)} className={`flex items-center justify-between bg-jtg-card border border-jtg-blue/30 rounded-xl p-3 text-left hover:border-jtg-green/50 transition-colors group ${mobile ? 'w-auto px-4 py-2 text-xs' : 'w-full'}`}>
                            <div className="flex items-center gap-3">
                                {!mobile && <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${activeProfile.type === 'CHALLENGE' ? 'bg-jtg-blue/20 text-jtg-green' : 'bg-slate-700 text-slate-300'}`}>{activeProfile.type === 'CHALLENGE' ? <Icons.Trophy2 /> : <Icons.Briefcase />}</div>}
                                <div className="overflow-hidden">
                                    {!mobile && <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">{activeProfile.type === 'CHALLENGE' ? 'Challenge' : 'Personal'}</p>}
                                    <p className={`${mobile ? 'text-xs' : 'text-sm'} font-bold text-white truncate`}>{activeProfile.name}</p>
                                </div>
                            </div>
                            <Icons.ChevronDown />
                        </button>
                        {showModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                                <div className="bg-jtg-card border border-jtg-blue/50 rounded-2xl p-6 w-full max-w-md shadow-2xl relative">
                                    <button onClick={() => setShowModal(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white">✕</button>
                                    <h3 className="text-xl font-bold text-white mb-4">Select Workspace</h3>
                                    <div className="space-y-2 mb-6 max-h-40 overflow-y-auto custom-scroll">
                                        {profiles.map(p => (
                                            <button key={p.id} onClick={() => { onSwitch(p.id); setShowModal(false); }} className={`w-full flex items-center justify-between p-3 rounded-xl border transition-all ${p.id === activeProfileId ? 'bg-jtg-blue/20 border-jtg-green/50 text-white' : 'bg-jtg-input border-transparent text-slate-400 hover:text-white'}`}>
                                                <span>{p.name}</span>
                                                {p.id === activeProfileId && <span className="text-jtg-green text-xs font-bold">ACTIVE</span>}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="border-t border-slate-700 pt-4">
                                        <h4 className="text-sm font-bold text-jtg-green mb-3 uppercase tracking-wide">Create New Profile</h4>
                                        <form onSubmit={handleSubmit} className="space-y-3">
                                            <input type="text" placeholder="Profile Name (e.g. FundedNext 100k)" value={newProfile.name} onChange={e => setNewProfile({...newProfile, name: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/30 rounded-lg p-2 text-white text-sm outline-none" required />
                                            <div className="grid grid-cols-2 gap-2">
                                                <select value={newProfile.type} onChange={e => setNewProfile({...newProfile, type: e.target.value})} className="bg-jtg-input border border-jtg-blue/30 rounded-lg p-2 text-white text-sm outline-none"><option value="PERSONAL">Personal Account</option><option value="CHALLENGE">Prop Firm Challenge</option></select>
                                                <input type="number" placeholder="Balance" value={newProfile.balance} onChange={e => setNewProfile({...newProfile, balance: e.target.value})} className="bg-jtg-input border border-jtg-blue/30 rounded-lg p-2 text-white text-sm outline-none" required />
                                            </div>
                                            {newProfile.type === 'CHALLENGE' && (
                                                <div className="grid grid-cols-3 gap-2 bg-jtg-blue/10 p-2 rounded-lg border border-jtg-blue/20">
                                                    <div><label className="text-[9px] text-slate-400 uppercase block">Daily Loss %</label><input type="number" value={newProfile.dailyLoss} onChange={e => setNewProfile({...newProfile, dailyLoss: e.target.value})} className="w-full bg-transparent border-b border-slate-600 text-white text-xs py-1 outline-none" /></div>
                                                    <div><label className="text-[9px] text-slate-400 uppercase block">Max Loss %</label><input type="number" value={newProfile.maxLoss} onChange={e => setNewProfile({...newProfile, maxLoss: e.target.value})} className="w-full bg-transparent border-b border-slate-600 text-white text-xs py-1 outline-none" /></div>
                                                    <div><label className="text-[9px] text-slate-400 uppercase block">Target %</label><input type="number" value={newProfile.profitTarget} onChange={e => setNewProfile({...newProfile, profitTarget: e.target.value})} className="w-full bg-transparent border-b border-slate-600 text-white text-xs py-1 outline-none" /></div>
                                                </div>
                                            )}
                                            <button type="submit" className="w-full bg-jtg-green hover:bg-emerald-600 text-white font-bold py-2 rounded-lg text-sm transition-colors mt-2">Create Profile</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- CHALLENGE STATUS ---
        const ChallengeStatus = ({ profile, trades }) => {
            if (!profile || profile.type !== 'CHALLENGE') return null;
            const rules = profile.rules || profile; 
            const dailyLossPct = parseFloat(rules.dailyLoss || 0);
            const maxLossPct = parseFloat(rules.maxLoss || 0);
            const profitTargetPct = parseFloat(rules.profitTarget || 0);
            const today = new Date().toISOString().split('T')[0];
            const todaysTrades = trades.filter(t => t.closeDate && t.closeDate.startsWith(today));
            const dailyLossAmt = Math.abs(todaysTrades.reduce((acc, t) => parseFloat(t.pnl) < 0 ? acc + parseFloat(t.pnl) : acc, 0));
            const totalPnL = trades.reduce((acc, t) => acc + parseFloat(t.pnl), 0);
            const startBal = parseFloat(profile.balance);
            const dailyLimit = startBal * (dailyLossPct / 100);
            const maxLimit = startBal * (maxLossPct / 100);
            const profitTarget = startBal * (profitTargetPct / 100);
            const dailyProgress = dailyLimit > 0 ? Math.min((dailyLossAmt / dailyLimit) * 100, 100) : 0;
            const maxProgress = (totalPnL < 0 && maxLimit > 0) ? Math.min((Math.abs(totalPnL) / maxLimit) * 100, 100) : 0;
            const targetProgress = (totalPnL > 0 && profitTarget > 0) ? Math.min((totalPnL / profitTarget) * 100, 100) : 0;

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div className="bg-jtg-card border border-jtg-blue/30 rounded-xl p-4 relative overflow-hidden"><div className="flex justify-between text-xs font-bold uppercase text-slate-400 mb-1"><span>Daily Loss</span><span>{dailyLossAmt.toFixed(0)} / {dailyLimit.toFixed(0)}</span></div><div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden"><div className={`h-full ${dailyProgress > 80 ? 'bg-red-500' : 'bg-jtg-blue'}`} style={{width: `${dailyProgress}%`}}></div></div></div>
                    <div className="bg-jtg-card border border-jtg-blue/30 rounded-xl p-4 relative overflow-hidden"><div className="flex justify-between text-xs font-bold uppercase text-slate-400 mb-1"><span>Max Drawdown</span><span>{Math.abs(Math.min(totalPnL, 0)).toFixed(0)} / {maxLimit.toFixed(0)}</span></div><div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden"><div className={`h-full ${maxProgress > 80 ? 'bg-red-500' : 'bg-purple-500'}`} style={{width: `${maxProgress}%`}}></div></div></div>
                    <div className="bg-jtg-card border border-jtg-blue/30 rounded-xl p-4 relative overflow-hidden"><div className="flex justify-between text-xs font-bold uppercase text-slate-400 mb-1"><span>Profit Target</span><span>{Math.max(totalPnL, 0).toFixed(0)} / {profitTarget.toFixed(0)}</span></div><div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-jtg-green" style={{width: `${targetProgress}%`}}></div></div></div>
                </div>
            );
        };

        // --- MAIN COMPONENTS ---

        const Calculator = ({ currentBalance }) => {
            const [balance, setBalance] = useState(currentBalance); 
            useEffect(() => { setBalance(currentBalance); }, [currentBalance]);
            const [riskMode, setRiskMode] = useState('percent'); 
            const [riskValue, setRiskValue] = useState(1.0); 
            const [assetClass, setAssetClass] = useState('indices'); 
            const [pair, setPair] = useState('US30');
            const [entryPrice, setEntryPrice] = useState('');
            const [stopLoss, setStopLoss] = useState('');
            const [takeProfit, setTakeProfit] = useState(''); 
            const [result, setResult] = useState(null);
            useEffect(() => { setPair(ASSETS[assetClass].pairs[0]); setResult(null); }, [assetClass]);
            const calculate = () => {
                if(!entryPrice || !stopLoss || !balance) return;
                const riskDollars = riskMode === 'percent' ? balance * (riskValue / 100) : parseFloat(riskValue);
                const entry = parseFloat(entryPrice); const sl = parseFloat(stopLoss); const tp = takeProfit ? parseFloat(takeProfit) : null; const dist = Math.abs(entry - sl);
                let contractSize = 1;
                if(pair.includes('XAU')) contractSize = 100; else if(pair.includes('XAG')) contractSize = 5000; else if(assetClass === 'forex') contractSize = 100000;
                let lot = 0; if(pair.includes('JPY') && assetClass === 'forex') lot = riskDollars / (dist * 100 * 6.8); else lot = riskDollars / (dist * contractSize);
                let profit = null; let rr = null;
                if(tp) { const reward = Math.abs(tp - entry); rr = (reward / dist).toFixed(2); profit = (riskDollars * (reward/dist)).toFixed(2); }
                setResult({ lot: lot.toFixed(2), risk: riskDollars.toFixed(2), rr: rr, profit: profit });
            };
            useEffect(() => { if(entryPrice && stopLoss && balance) { const t = setTimeout(calculate, 300); return () => clearTimeout(t); } }, [balance, riskMode, riskValue, entryPrice, stopLoss, takeProfit, pair]);
            return (
                <div className="flex flex-col h-full overflow-y-auto custom-scroll p-4 md:p-10 pb-24 md:pb-10">
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 animate-pop mb-auto">
                        <div className="lg:col-span-7 space-y-8">
                            <div className="flex gap-2 p-1.5 bg-jtg-input rounded-xl overflow-x-auto shadow-inner border border-jtg-blue/30 no-scrollbar">
                                {Object.keys(ASSETS).map(key => ( <button key={key} onClick={() => setAssetClass(key)} className={`flex-1 py-3 px-4 rounded-lg text-xs font-bold uppercase tracking-widest transition-all whitespace-nowrap ${assetClass === key ? 'bg-gradient-to-r from-jtg-blue to-blue-700 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>{ASSETS[key].label}</button> ))}
                            </div>
                            <div className="bg-jtg-card border border-jtg-blue/30 rounded-2xl p-8 shadow-2xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-jtg-green to-jtg-blue"></div>
                                <div className="mb-8"><label className="text-xs font-bold text-slate-400 uppercase mb-3 block tracking-wider">Instrument</label><div className="relative"><select value={pair} onChange={(e) => setPair(e.target.value)} className="w-full bg-jtg-input border border-jtg-blue/40 text-white text-lg font-medium rounded-xl p-4 pr-10 focus:ring-2 focus:ring-jtg-green/50 outline-none appearance-none">{ASSETS[assetClass].pairs.map(p => <option key={p} value={p}>{p}</option>)}</select><div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"><Icons.ChevronDown /></div></div></div>
                                <div className="grid grid-cols-2 gap-6 mb-8">
                                    <div><label className="text-xs font-bold text-slate-400 uppercase mb-3 block">Balance</label><input type="number" value={balance} onChange={(e) => setBalance(e.target.value)} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-xl p-4 text-white font-mono text-lg font-medium focus:ring-2 focus:ring-jtg-green/50 outline-none" /></div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase mb-3 block">Risk</label><div className="flex bg-jtg-input border border-jtg-blue/40 rounded-xl overflow-hidden"><input type="number" value={riskValue} onChange={(e) => setRiskValue(e.target.value)} className="w-full bg-transparent p-4 text-white font-mono text-lg font-medium outline-none z-10" /><button onClick={() => setRiskMode(riskMode === 'percent' ? 'usd' : 'percent')} className="bg-jtg-blue/20 border-l border-jtg-blue/40 px-6 text-sm font-bold text-jtg-green hover:bg-jtg-blue/40 transition">{riskMode === 'percent' ? '%' : '$'}</button></div></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div><label className="text-xs font-bold text-jtg-green uppercase">Entry</label><input type="number" placeholder="0.00" value={entryPrice} onChange={(e) => setEntryPrice(e.target.value)} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-xl p-4 text-white font-mono focus:ring-2 focus:ring-jtg-green/50 outline-none" /></div>
                                    <div><label className="text-xs font-bold text-red-500 uppercase">Stop Loss</label><input type="number" placeholder="0.00" value={stopLoss} onChange={(e) => setStopLoss(e.target.value)} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-xl p-4 text-white font-mono focus:ring-2 focus:ring-red-500/50 outline-none" /></div>
                                    <div><label className="text-xs font-bold text-slate-400 uppercase">TP (Opt)</label><input type="number" placeholder="Optional" value={takeProfit} onChange={(e) => setTakeProfit(e.target.value)} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-xl p-4 text-white font-mono focus:ring-2 focus:ring-slate-500 outline-none" /></div>
                                </div>
                                <button onClick={calculate} className="w-full mt-10 bg-gradient-to-r from-jtg-green to-emerald-600 hover:from-emerald-600 hover:to-jtg-green text-white font-bold uppercase tracking-widest py-5 rounded-xl shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-2 text-sm">Calculate Position</button>
                            </div>
                        </div>
                        <div className="lg:col-span-5 flex flex-col gap-8">
                            <div className="bg-gradient-to-b from-jtg-card to-jtg-dark border border-jtg-blue/30 rounded-2xl p-10 text-center relative overflow-hidden shadow-2xl min-h-[350px] flex flex-col justify-center items-center">
                                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-40 h-1 bg-jtg-green shadow-[0_0_50px_rgba(27,166,87,0.6)]"></div>
                                {result ? (
                                    <div className="animate-pop w-full">
                                        <p className="text-slate-400 text-xs font-bold uppercase tracking-[0.3em] mb-4">Recommended Position</p>
                                        <div className="text-8xl font-black text-white tracking-tighter drop-shadow-2xl mb-4 leading-none">{result.lot}</div>
                                        <div className="inline-block bg-jtg-green/10 text-jtg-green border border-jtg-green/20 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-widest mb-10">Standard Lots</div>
                                        <div className="w-full h-px bg-jtg-blue/30 mb-8"></div>
                                        <div className="flex justify-between items-center w-full px-2 mb-6">
                                            <div className="text-left"><p className="text-slate-500 text-[10px] font-bold uppercase mb-1">Risk</p><p className="text-xl font-bold text-red-500 font-mono">${result.risk}</p></div>
                                            {result.profit && <div className="text-right"><p className="text-slate-500 text-[10px] font-bold uppercase mb-1">Gain</p><p className="text-xl font-bold text-jtg-green font-mono">+${result.profit}</p></div>}
                                        </div>
                                        {result.rr && <div className="w-full bg-slate-800/40 rounded-xl p-4 border border-slate-700/50 flex justify-between items-center"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-jtg-green"></div><span className="text-slate-400 text-xs font-bold uppercase">R:R</span></div><span className="text-white font-mono text-xl font-bold">1 : {result.rr}</span></div>}
                                    </div>
                                ) : (
                                    <div className="opacity-20 flex flex-col items-center"><div className="w-24 h-24 border-4 border-slate-700 rounded-full flex items-center justify-center mb-6"><span className="text-4xl text-slate-600">--</span></div><p className="text-sm font-medium tracking-wide">Awaiting Details</p></div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Journal = ({ addTrade }) => {
            const [formData, setFormData] = useState({ openDate: new Date().toISOString().slice(0, 16), closeDate: '', strategy: '', pair: 'US30', type: 'BUY', entry: '', sl: '', tp: '', lot: '', exit: '' });
            const handleSubmit = (e) => {
                e.preventDefault();
                addTrade(formData);
                setFormData({ ...formData, entry: '', sl: '', tp: '', lot: '', exit: '', closeDate: '' });
            };
            return (
                <div className="flex flex-col items-center min-h-full w-full animate-pop overflow-y-auto custom-scroll p-4 md:p-10 pb-24 md:pb-10">
                    <div className="bg-jtg-card border border-jtg-blue/30 rounded-2xl p-8 shadow-xl w-full max-w-2xl mb-8 shrink-0">
                        <div className="flex items-center gap-3 mb-6 border-b border-jtg-blue/20 pb-4"><div className="w-10 h-10 rounded-full bg-jtg-blue/20 flex items-center justify-center text-jtg-green"><Icons.Journal /></div><h2 className="text-2xl font-bold text-white tracking-wide">Log New Trade</h2></div>
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Open Date</label><input type="datetime-local" value={formData.openDate} onChange={e => setFormData({...formData, openDate: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white text-xs outline-none" required /></div><div><label className="text-[10px] font-bold text-jtg-green uppercase mb-1 block">Close Date (Required)</label><input type="datetime-local" value={formData.closeDate} onChange={e => setFormData({...formData, closeDate: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white text-xs outline-none" required /></div></div>
                            <div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Strategy Name</label><input type="text" placeholder="e.g. London Breakout" value={formData.strategy} onChange={e => setFormData({...formData, strategy: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none" required /></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Pair</label><select value={formData.pair} onChange={e => setFormData({...formData, pair: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none">{ASSETS.indices.pairs.concat(ASSETS.forex.pairs, ASSETS.crypto.pairs, ASSETS.metals.pairs).sort().map(p => <option key={p} value={p}>{p}</option>)}</select></div><div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Type</label><select value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none"><option value="BUY">BUY</option><option value="SELL">SELL</option></select></div></div>
                            <div className="grid grid-cols-3 gap-3"><div><label className="text-[10px] font-bold text-jtg-green uppercase mb-1 block">Entry</label><input type="number" step="any" value={formData.entry} onChange={e => setFormData({...formData, entry: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none" required /></div><div><label className="text-[10px] font-bold text-red-500 uppercase mb-1 block">SL</label><input type="number" step="any" value={formData.sl} onChange={e => setFormData({...formData, sl: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none" /></div><div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">TP</label><input type="number" step="any" value={formData.tp} onChange={e => setFormData({...formData, tp: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none" /></div></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Lot Size</label><input type="number" step="0.01" value={formData.lot} onChange={e => setFormData({...formData, lot: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none" required /></div><div><label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Exit Price</label><input type="number" step="any" value={formData.exit} onChange={e => setFormData({...formData, exit: e.target.value})} className="w-full bg-jtg-input border border-jtg-blue/40 rounded-lg p-3 text-white outline-none" /></div></div>
                            <button type="submit" className="w-full bg-jtg-green hover:bg-emerald-600 text-white font-bold py-4 rounded-lg mt-6 transition-colors flex items-center justify-center gap-2 shadow-lg"><Icons.Plus /> ADD ENTRY TO LOGS</button>
                        </form>
                    </div>
                </div>
            );
        };

        const TradeList = ({ trades, deleteTrade }) => {
            const captureRef = useRef(null);

            const downloadCard = async (trade) => {
                const element = document.createElement('div');
                element.style.cssText = `
                    background: radial-gradient(circle at top right, #111633 0%, #0a0e29 100%);
                    width: 600px;
                    padding: 50px;
                    border-radius: 30px;
                    font-family: 'Inter', sans-serif;
                    color: white;
                    display: flex;
                    flex-direction: column;
                    gap: 0;
                    position: relative;
                    overflow: hidden;
                    border: 1px solid #162C99;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                `;
                
                const isWin = parseFloat(trade.pnl) >= 0;
                const accentColor = isWin ? '#1BA657' : '#EF4444';
                
                element.innerHTML = `
                    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: ${accentColor}; opacity: 0.15; filter: blur(60px); border-radius: 50%;"></div>
                    <div style="position: absolute; bottom: -50px; left: -50px; width: 150px; height: 150px; background: #162C99; opacity: 0.15; filter: blur(50px); border-radius: 50%;"></div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; position: relative; z-index: 10;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <!-- SVG LOGO for Share Card (No CORS Issues) -->
                            <img src="${LOGO_URL}" style="width: 50px; height: 50px; object-fit: contain;" crossorigin="anonymous" />
                            <span style="font-size: 20px; font-weight: 800; letter-spacing: 1px;">JTG FX JOURNAL</span>
                        </div>
                        <span style="font-size: 14px; opacity: 0.6; font-weight: 500;">${new Date().toLocaleDateString()}</span>
                    </div>

                    <div style="text-align: center; margin-bottom: 40px; position: relative; z-index: 10;">
                        <p style="margin: 0; font-size: 14px; color: #94a3b8; text-transform: uppercase; letter-spacing: 2px; font-weight: 600;">Net Profit / Loss</p>
                        <h1 style="margin: 10px 0 0; font-size: 64px; font-weight: 900; color: ${accentColor}; text-shadow: 0 0 30px ${accentColor}40;">
                            ${isWin ? '+' : ''}$${trade.pnl}
                        </h1>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px; position: relative; z-index: 10;">
                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05);">
                            <p style="margin: 0; font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px;">Pair</p>
                            <p style="margin: 0; font-size: 24px; font-weight: 800;">${trade.pair}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05);">
                            <p style="margin: 0; font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px;">Strategy</p>
                            <!-- FIXED TEXT CLIPPING: Added Line-Height and Padding -->
                            <p style="margin: 0; font-size: 18px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; line-height: 1.5; padding-bottom: 10px; display: block;">${trade.strategy || 'Standard'}</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 25px; position: relative; z-index: 10;">
                        <div>
                            <p style="margin: 0; font-size: 12px; color: #64748b;">Type</p>
                            <p style="margin: 5px 0 0; font-size: 16px; font-weight: 600; color: ${trade.type === 'BUY' ? '#1BA657' : '#EF4444'};">${trade.type}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-size: 12px; color: #64748b;">Visit</p>
                            <p style="margin: 5px 0 0; font-size: 14px; font-weight: 600; opacity: 0.8;">jtg-journals.vercel.app</p>
                        </div>
                    </div>
                `;

                document.body.appendChild(element);
                const canvas = await html2canvas(element, { backgroundColor: null, scale: 2, useCORS: true });
                document.body.removeChild(element);

                const link = document.createElement('a');
                link.download = `JTG_Trade_${trade.pair}_${trade.id}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            };

            return (
                <div className="flex flex-col h-full animate-pop overflow-y-auto custom-scroll p-4 md:p-10 pb-24 md:pb-10">
                    <div className="bg-jtg-card border border-jtg-blue/30 rounded-2xl p-6 shadow-xl flex-1 flex flex-col mb-8 overflow-hidden min-h-[500px]">
                        <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-white tracking-wide flex items-center gap-3"><span className="text-jtg-green"><Icons.List /></span> Trade History</h2><div className="bg-jtg-blue/20 px-4 py-2 rounded-full border border-jtg-blue/40"><span className="text-white font-bold font-mono">{trades.length}</span> <span className="text-slate-400 text-xs uppercase">Records</span></div></div>
                        <div className="flex-1 overflow-auto custom-scroll">
                            <table className="w-full text-left border-collapse min-w-[1000px]">
                                <thead className="sticky top-0 bg-jtg-card z-10 shadow-lg"><tr><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Opened</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Closed</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Strategy</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Pair</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Type</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Lot</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Entry</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Exit</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700">Outcome</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700 text-right">PnL</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700 text-center">Share</th><th className="p-4 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-700 text-center">Action</th></tr></thead>
                                <tbody>
                                    {trades.length === 0 ? ( <tr><td colSpan="12" className="p-12 text-center text-slate-500 italic">No trade history found. Go to Journal to add entries.</td></tr> ) : ( trades.map(trade => (
                                        <tr key={trade.id} className="border-b border-slate-800 hover:bg-slate-800/30 transition-colors group">
                                            <td className="p-4 text-xs text-white font-mono">{trade.openDate.split('T')[0]}</td>
                                            <td className="p-4 text-xs text-slate-400 font-mono">{trade.closeDate ? trade.closeDate.split('T')[0] : '-'}</td>
                                            <td className="p-4 text-xs text-white font-medium">{trade.strategy}</td>
                                            <td className="p-4 text-sm font-bold text-white">{trade.pair}</td>
                                            <td className={`p-4 text-xs font-bold ${trade.type === 'BUY' ? 'text-jtg-green' : 'text-red-500'}`}>{trade.type}</td>
                                            <td className="p-4 text-xs text-slate-300 font-mono">{trade.lot}</td>
                                            <td className="p-4 text-xs font-mono text-white">{trade.entry}</td>
                                            <td className="p-4 text-xs font-mono text-slate-400">{trade.exit || '-'}</td>
                                            <td className="p-4"><span className={`text-[10px] font-bold px-2 py-1 rounded border ${trade.outcome.includes('WIN') || trade.outcome.includes('TP') ? 'bg-jtg-green/10 text-jtg-green border-jtg-green/30' : trade.outcome.includes('LOSS') || trade.outcome.includes('SL') ? 'bg-red-500/10 text-red-500 border-red-500/30' : 'bg-slate-700 text-slate-300 border-slate-600'}`}>{trade.outcome}</span></td>
                                            <td className={`p-4 text-sm font-mono font-bold text-right ${parseFloat(trade.pnl) >= 0 ? 'text-jtg-green' : 'text-red-500'}`}>{parseFloat(trade.pnl) >= 0 ? '+' : ''}{trade.pnl}</td>
                                            <td className="p-4 text-center">
                                                <button onClick={() => downloadCard(trade)} className="text-slate-500 hover:text-jtg-green transition-colors"><Icons.Share /></button>
                                            </td>
                                            <td className="p-4 text-center"><button onClick={() => deleteTrade(trade.id)} className="text-slate-600 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><Icons.Trash /></button></td>
                                        </tr>
                                    )))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <JtgPromo />
                </div>
            );
        };

        const Performance = ({ trades }) => {
            const stats = useMemo(() => {
                const total = trades.length;
                const wins = trades.filter(t => parseFloat(t.pnl) > 0).length;
                const grossProfit = trades.reduce((acc, t) => parseFloat(t.pnl) > 0 ? acc + parseFloat(t.pnl) : acc, 0);
                const grossLoss = Math.abs(trades.reduce((acc, t) => parseFloat(t.pnl) < 0 ? acc + parseFloat(t.pnl) : acc, 0));
                const netPnL = grossProfit - grossLoss;
                const pairStats = {};
                trades.forEach(t => { if (!pairStats[t.pair]) pairStats[t.pair] = 0; pairStats[t.pair] += parseFloat(t.pnl); });
                let bestPair = '-'; let maxPnL = -Infinity;
                Object.entries(pairStats).forEach(([pair, pnl]) => { if (pnl > maxPnL) { maxPnL = pnl; bestPair = pair; } });
                if(Object.keys(pairStats).length === 0) bestPair = 'N/A';
                return { total, wins, loss: total - wins, winRate: total > 0 ? ((wins / total) * 100).toFixed(1) : 0, netPnL: netPnL.toFixed(2), profitFactor: grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : grossProfit > 0 ? '∞' : 0, bestPair };
            }, [trades]);

            const StatCard = ({ title, value, sub, color, icon }) => (
                <div className="bg-jtg-card border border-jtg-blue/30 rounded-2xl p-6 shadow-lg relative overflow-hidden group">
                    <div className={`absolute top-0 right-0 w-24 h-24 bg-${color}-500/10 rounded-full blur-xl -mr-6 -mt-6 transition-all group-hover:bg-${color}-500/20`}></div>
                    <div className="flex justify-between items-start mb-2"><p className="text-slate-400 text-xs font-bold uppercase tracking-wider">{title}</p>{icon}</div>
                    <div className={`text-4xl font-black tracking-tight ${color === 'emerald' ? 'text-jtg-green' : color === 'red' ? 'text-red-500' : 'text-white'}`}>{value}</div>
                    {sub && <p className="text-slate-500 text-xs mt-1 font-mono">{sub}</p>}
                </div>
            );

            return (
                <div className="animate-pop overflow-y-auto custom-scroll p-4 md:p-10 pb-24 md:pb-10 h-full flex flex-col">
                    <div className="mb-auto">
                        <ChallengeStatus profile={window.currentProfile} trades={trades} />
                        <h2 className="text-3xl font-bold text-white mb-8 tracking-wide">Performance Data</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <StatCard title="Net PnL" value={`$${stats.netPnL}`} color={parseFloat(stats.netPnL) >= 0 ? 'emerald' : 'red'} />
                            <StatCard title="Win Rate" value={`${stats.winRate}%`} color="white" />
                            <StatCard title="Profit Factor" value={stats.profitFactor} color="white" />
                            <StatCard title="Top Pair" value={stats.bestPair} color="emerald" icon={<span className="text-jtg-green"><Icons.Trophy /></span>} />
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                            <StatCard title="Total Trades" value={stats.total} color="white" />
                            <StatCard title="Winning Trades" value={stats.wins} color="emerald" icon={<span className="text-jtg-green"><Icons.ThumbsUp /></span>} />
                            <StatCard title="Losing Trades" value={stats.loss} color="red" icon={<span className="text-red-500"><Icons.ThumbsDown /></span>} />
                        </div>
                    </div>
                    <JtgPromo />
                </div>
            );
        };

        const CalendarView = ({ trades }) => {
            const [date, setDate] = useState(new Date());
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            const pnlMap = useMemo(() => {
                const map = {};
                trades.forEach(t => { if (t.closeDate) { const day = t.closeDate.split('T')[0]; if (!map[day]) map[day] = 0; map[day] += parseFloat(t.pnl); } });
                return map;
            }, [trades]);

            const year = date.getFullYear();
            const month = date.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(i);
            const prevMonth = () => setDate(new Date(year, month - 1, 1));
            const nextMonth = () => setDate(new Date(year, month + 1, 1));

            return (
                <div className="flex flex-col h-full animate-pop overflow-y-auto custom-scroll p-4 md:p-10 pb-24 md:pb-10">
                    <div className="bg-jtg-card border border-jtg-blue/30 rounded-2xl p-6 shadow-xl flex-1 flex flex-col mb-8 overflow-hidden min-h-[600px]">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 className="text-2xl font-bold text-white tracking-wide flex items-center gap-3"><span className="text-jtg-green"><Icons.Calendar /></span> Performance Calendar</h2>
                            <div className="flex items-center gap-4 bg-jtg-input rounded-lg p-1 border border-jtg-blue/30">
                                <button onClick={prevMonth} className="p-2 hover:text-white text-slate-400"><Icons.ChevronLeft /></button>
                                <span className="text-sm font-bold w-32 text-center text-white">{monthNames[month]} {year}</span>
                                <button onClick={nextMonth} className="p-2 hover:text-white text-slate-400"><Icons.ChevronRight /></button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto custom-scroll">
                            <div className="grid grid-cols-7 gap-px bg-jtg-blue/20 border border-jtg-blue/30 rounded-t-xl overflow-hidden text-center text-xs font-bold text-slate-400 uppercase py-2"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                            <div className="grid grid-cols-7 gap-2 mt-2 h-[600px] auto-rows-fr">
                                {days.map((day, idx) => {
                                    if (!day) return <div key={idx} className="bg-transparent"></div>;
                                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                    const pnl = pnlMap[dateStr];
                                    let bgClass = "bg-jtg-input border border-slate-800"; let textClass = "text-slate-500";
                                    if (pnl > 0) { bgClass = "bg-jtg-green/20 border border-jtg-green/40 shadow-[0_0_15px_rgba(27,166,87,0.15)]"; textClass = "text-jtg-green"; }
                                    else if (pnl < 0) { bgClass = "bg-red-500/10 border border-red-500/30"; textClass = "text-red-500"; }
                                    return (
                                        <div key={idx} className={`${bgClass} rounded-xl p-3 flex flex-col justify-between transition-all hover:scale-[1.02] cursor-default`}>
                                            <span className="text-slate-400 text-xs font-bold">{day}</span>
                                            {pnl !== undefined && <div className={`text-sm md:text-lg font-black tracking-tight ${textClass} break-all`}>{pnl > 0 ? '+' : ''}{pnl.toFixed(0)}</div>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                    <JtgPromo />
                </div>
            );
        };

        const App = () => {
            const [page, setPage] = useState('calc'); 
            const [imgError, setImgError] = useState(false);
            const [user, setUser] = useState(null);
            const [isLoggingIn, setIsLoggingIn] = useState(false);
            
            // --- PROFILE STATE ---
            const [profiles, setProfiles] = useState(() => {
                const saved = localStorage.getItem('jtg_profiles');
                return saved ? JSON.parse(saved) : [{ id: 'default', type: 'PERSONAL', name: 'Personal Account', balance: 1000 }];
            });
            const [activeProfileId, setActiveProfileId] = useState(() => localStorage.getItem('jtg_active_profile') || 'default');

            const activeProfile = profiles.find(p => p.id === activeProfileId) || profiles[0];
            // Hack to pass profile to Performance view without prop drilling too much for this demo
            window.currentProfile = activeProfile;

            // --- TRADE STATE ---
            const [trades, setTrades] = useState(() => {
                try {
                    const saved = localStorage.getItem('jtg_journal');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });

            // Filter trades for current profile
            const currentTrades = useMemo(() => trades.filter(t => t.profileId === activeProfileId), [trades, activeProfileId]);

            // Calc Current Balance
            const currentBalance = useMemo(() => {
                const pnl = currentTrades.reduce((acc, t) => acc + parseFloat(t.pnl || 0), 0);
                return parseFloat(activeProfile.balance) + pnl;
            }, [currentTrades, activeProfile]);

            useEffect(() => {
                if (!user) {
                    localStorage.setItem('jtg_journal', JSON.stringify(trades));
                    localStorage.setItem('jtg_profiles', JSON.stringify(profiles));
                    localStorage.setItem('jtg_active_profile', activeProfileId);
                }
            }, [trades, profiles, activeProfileId, user]);

            // AUTH & CLOUD SYNC
            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                        setUser(currentUser);
                        if (currentUser) {
                            try {
                                // Load Profiles
                                const pSnap = await db.collection('profiles').where('userId', '==', currentUser.uid).get();
                                if (!pSnap.empty) {
                                    const cloudProfiles = pSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                    setProfiles(cloudProfiles);
                                }
                                // Load Trades
                                const q = db.collection('trades').where('userId', '==', currentUser.uid);
                                const snapshot = await q.get();
                                const cloudTrades = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                setTrades(cloudTrades);
                            } catch (e) { console.error(e); }
                        }
                    });
                    return () => unsubscribe();
                }
            }, []);

            const login = async () => {
                if (!auth) return alert("Firebase not configured!");
                setIsLoggingIn(true);
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (error) { alert(error.message); } finally { setIsLoggingIn(false); }
            };

            const logout = async () => {
                if (auth) await auth.signOut();
                setTrades([]); 
                window.location.reload(); 
            };

            const addTrade = async (formData) => {
                const e = parseFloat(formData.entry), x = parseFloat(formData.exit), s = parseFloat(formData.sl), t = parseFloat(formData.tp);
                let outcome = 'OPEN';
                if(x) {
                    if (formData.type === 'BUY') {
                        if (s && x <= s) outcome = 'HIT SL';
                        else if (t && x >= t) outcome = 'HIT TP';
                        else if (Math.abs(x - e) < (e * 0.0002)) outcome = 'BREAKEVEN';
                        else if (x > e) outcome = 'MANUAL WIN';
                        else outcome = 'MANUAL LOSS';
                    } else {
                        if (s && x >= s) outcome = 'HIT SL';
                        else if (t && x <= t) outcome = 'HIT TP';
                        else if (Math.abs(x - e) < (e * 0.0002)) outcome = 'BREAKEVEN';
                        else if (x < e) outcome = 'MANUAL WIN';
                        else outcome = 'MANUAL LOSS';
                    }
                }
                
                let contract = 1;
                if(formData.pair.includes('XAU')) contract = 100;
                else if(formData.pair.includes('XAG')) contract = 5000;
                else if(formData.pair.length === 6 && !formData.pair.includes('USD')) contract = 100000;
                else if(formData.pair.includes('USD') && formData.pair.length === 6 && !formData.pair.includes('BTC') && !formData.pair.includes('ETH')) contract = 100000;
                
                let pnl = '0.00';
                if(x) {
                    const diff = formData.type === 'BUY' ? (x - e) : (e - x);
                    if (formData.pair.includes('JPY')) pnl = ((diff * 100 * 6.8) * formData.lot).toFixed(2);
                    else pnl = (diff * formData.lot * contract).toFixed(2);
                }

                const newTrade = { ...formData, id: Date.now(), outcome, pnl, userId: user ? user.uid : 'guest', profileId: activeProfileId };

                if (user) {
                     try { await db.collection('trades').add(newTrade); setTrades([newTrade, ...trades]); } catch (e) { alert("Error saving to cloud: " + e.message); }
                } else {
                    setTrades([newTrade, ...trades]);
                }
            };

            const deleteTrade = async (id) => {
                setTrades(trades.filter(t => t.id !== id));
            };

            const addProfile = async (profile) => {
                const newProfile = { ...profile, userId: user ? user.uid : 'guest' };
                if (user) {
                    await db.collection('profiles').add(newProfile);
                }
                setProfiles([...profiles, newProfile]);
                setActiveProfileId(newProfile.id);
            };

            const NavBtn = ({ id, icon, label }) => (
                <button onClick={() => setPage(id)} className={`flex flex-col items-center gap-1 w-full py-4 transition-all duration-300 border-l-4 ${page === id ? 'border-jtg-green bg-jtg-blue/20 text-white' : 'border-transparent text-slate-500 hover:text-slate-300'}`}>
                    <span className={page === id ? 'text-jtg-green' : 'text-current'}>{icon}</span>
                    <span className="text-[10px] font-bold tracking-wider">{label}</span>
                </button>
            );

            return (
                <div className="flex w-full h-full bg-jtg-dark">
                    {/* SIDEBAR */}
                    <div className="hidden md:flex w-64 bg-jtg-dark border-r border-jtg-blue/30 flex-col py-6 z-20 shadow-2xl shrink-0 h-full overflow-y-auto custom-scroll justify-between">
                        <div className="w-full flex flex-col">
                            <div className="w-full flex justify-center mb-6">
                                <div className="w-16 h-16 flex items-center justify-center transition-transform hover:scale-110">
                                    <img src={LOGO_URL} className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} crossorigin="anonymous" />
                                </div>
                            </div>

                            <ProfileManager profiles={profiles} activeProfileId={activeProfileId} onSwitch={setActiveProfileId} onAdd={addProfile} />

                            <div className="flex flex-col gap-1 w-full px-2">
                                <button onClick={() => setPage('calc')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 ${page === 'calc' ? 'bg-jtg-blue/20 text-white border border-jtg-green/30' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                    <Icons.Calculator /><span className="text-sm font-bold tracking-wide">CALCULATOR</span>
                                </button>
                                <button onClick={() => setPage('journal')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 ${page === 'journal' ? 'bg-jtg-blue/20 text-white border border-jtg-green/30' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                    <Icons.Journal /><span className="text-sm font-bold tracking-wide">JOURNAL ENTRY</span>
                                </button>
                                <button onClick={() => setPage('trades')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 ${page === 'trades' ? 'bg-jtg-blue/20 text-white border border-jtg-green/30' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                    <Icons.List /><span className="text-sm font-bold tracking-wide">TRADE LOGS</span>
                                </button>
                                <button onClick={() => setPage('calendar')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 ${page === 'calendar' ? 'bg-jtg-blue/20 text-white border border-jtg-green/30' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                    <Icons.Calendar /><span className="text-sm font-bold tracking-wide">CALENDAR</span>
                                </button>
                                <button onClick={() => setPage('perf')} className={`flex items-center gap-3 w-full px-4 py-3 rounded-xl transition-all duration-300 ${page === 'perf' ? 'bg-jtg-blue/20 text-white border border-jtg-green/30' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                    <Icons.Chart /><span className="text-sm font-bold tracking-wide">ANALYTICS</span>
                                </button>
                            </div>
                        </div>
                        
                        <div className="w-full px-4 mt-8 flex flex-col gap-3">
                            {user ? (
                                <button onClick={logout} className="flex items-center justify-center gap-2 w-full py-3 rounded-lg border border-red-500/30 text-red-400 hover:bg-red-500/10 transition text-xs font-bold">
                                    LOGOUT ({user.email.split('@')[0]})
                                </button>
                            ) : (
                                <button onClick={login} className="flex items-center justify-center gap-2 w-full py-3 rounded-lg bg-white text-slate-900 hover:bg-slate-200 transition text-xs font-bold">
                                    <Icons.Google /> SIGN IN
                                </button>
                            )}
                            <button onClick={() => window.location.href = 'https://johnadtradersgroup.vercel.app/#services'} className="flex items-center justify-center gap-2 text-slate-500 hover:text-white transition text-xs font-bold py-2">
                                <Icons.Home /> WEBSITE
                            </button>
                        </div>
                    </div>

                    {/* MOBILE HEADER */}
                    <div className="md:hidden fixed top-0 w-full bg-jtg-dark/95 backdrop-blur z-30 border-b border-jtg-blue/30 p-4 flex justify-between items-center h-16">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8"><img src={LOGO_URL} className="w-full h-full object-contain" onError={(e) => e.target.style.display='none'} crossorigin="anonymous" /></div>
                            <span className="text-lg font-bold text-white tracking-wide">JTG <span className="text-jtg-green">JOURNAL</span></span>
                        </div>
                        <div className="flex items-center gap-2">
                            <ProfileManager profiles={profiles} activeProfileId={activeProfileId} onSwitch={setActiveProfileId} onAdd={addProfile} mobile />
                        </div>
                    </div>

                    {/* MOBILE BOTTOM NAV */}
                    <div className="md:hidden fixed bottom-0 w-full bg-jtg-dark border-t border-jtg-blue/30 z-30 flex justify-around pb-safe h-20 items-center">
                        <button onClick={() => setPage('calc')} className={`p-2 flex flex-col items-center ${page === 'calc' ? 'text-jtg-green' : 'text-slate-500'}`}><Icons.Calculator /><span className="text-[9px] font-bold mt-1">Calc</span></button>
                        <button onClick={() => setPage('journal')} className={`p-2 flex flex-col items-center ${page === 'journal' ? 'text-jtg-green' : 'text-slate-500'}`}><Icons.Journal /><span className="text-[9px] font-bold mt-1">Entry</span></button>
                        <button onClick={() => setPage('trades')} className={`p-2 flex flex-col items-center ${page === 'trades' ? 'text-jtg-green' : 'text-slate-500'}`}><Icons.List /><span className="text-[9px] font-bold mt-1">Trades</span></button>
                        <button onClick={() => setPage('calendar')} className={`p-2 flex flex-col items-center ${page === 'calendar' ? 'text-jtg-green' : 'text-slate-500'}`}><Icons.Calendar /><span className="text-[9px] font-bold mt-1">Cal</span></button>
                        <button onClick={() => setPage('perf')} className={`p-2 flex flex-col items-center ${page === 'perf' ? 'text-jtg-green' : 'text-slate-500'}`}><Icons.Chart /><span className="text-[9px] font-bold mt-1">Data</span></button>
                    </div>

                    {/* MAIN CONTENT AREA */}
                    <main className="flex-1 relative h-full w-full overflow-hidden">
                        <div className="absolute inset-0 bg-jtg-dark w-full h-full overflow-hidden">
                            <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-jtg-blue/10 rounded-full blur-[120px] pointer-events-none"></div>
                            <div className="absolute bottom-0 left-0 w-[500px] h-[500px] bg-jtg-green/5 rounded-full blur-[100px] pointer-events-none"></div>
                            
                            <div className="w-full h-full overflow-y-auto custom-scroll pt-20 pb-24 md:pt-0 md:pb-0">
                                {page === 'calc' && <Calculator currentBalance={currentBalance} />}
                                {page === 'journal' && <Journal addTrade={addTrade} />}
                                {page === 'trades' && <TradeList trades={currentTrades} deleteTrade={deleteTrade} />}
                                {page === 'calendar' && <CalendarView trades={currentTrades} />}
                                {page === 'perf' && <Performance trades={currentTrades} />}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
